<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Todos Bilingües</title>

    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        /* Estilo básico para evitar la pantalla en blanco mientras carga */
        body { margin: 0; font-family: sans-serif; background-color: #f3f4f6; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // El código completo de tu aplicación va aquí adentro.
        
        // Estilos Globales y Variables de Color Personalizables
        const GlobalStyles = () => (
          <style>{`
            @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
            
            :root {
              /* --- INICIO DE LA ZONA DE COLORES EDITABLE --- */
              --color-primario: #006a7a;
              --color-primario-hover: #004d59;
              --color-secundario: #4f46e5;
              --color-terciario: #9333ea; 
              --color-acento: #10b981;
              --color-acento-hover: #059669;
              --color-peligro: #ef4444;
              --color-fondo: #d5e3e8;
              --color-superficie: #ffffff;
              --color-borde: #d1d5db;
              --color-texto-principal: #111827;
              --color-texto-secundario: #6b7281;
              --color-texto-invertido: #ffffff;
              /* --- FIN DE LA ZONA DE COLORES EDITABLE --- */
            }

            body {
              font-family: 'Inter', sans-serif;
              background-color: var(--color-fondo);
              color: var(--color-texto-principal);
              margin: 0;
              -webkit-font-smoothing: antialiased;
              -moz-osx-font-smoothing: grayscale;
            }
            
            .watermark-bg {
                position: relative;
                z-index: 1;
            }

            .watermark-bg::before {
                content: '';
                position: fixed;
                top: 0;
                left: 0;
                width: 100vw;
                height: 100vh;
                background-image: url('black_icon_white_background.png');
                background-repeat: no-repeat;
                background-position: center center;
                background-size: contain;
                opacity: 0.05;
                z-index: -1;
            }

            .app-layout {
                display: flex;
            }

            .main-content {
                flex-grow: 1;
                padding: 2.5rem;
                height: 100vh;
                overflow-y: auto;
                box-sizing: border-box;
            }
            
            .card {
              background-color: var(--color-superficie);
              border-radius: 0.75rem;
              border: 1px solid var(--color-borde);
              padding: 1.5rem;
              box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
              transition: all 0.3s ease;
              overflow: hidden;
            }
            .card-clickable:hover {
                box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
                transform: translateY(-4px);
                cursor: pointer;
            }

            .btn {
              display: inline-flex;
              align-items: center;
              justify-content: center;
              gap: 0.5rem;
              font-weight: 600;
              padding: 0.75rem 1.5rem;
              border-radius: 0.5rem;
              border: none;
              cursor: pointer;
              text-align: center;
              transition: background-color 0.3s ease, opacity 0.3s ease, transform 0.3s ease;
              text-decoration: none;
            }
            .btn:disabled {
                opacity: 0.6;
                cursor: not-allowed;
            }

            .btn-primario {
              background-color: var(--color-primario);
              color: var(--color-texto-invertido);
            }
            .btn-primario:hover:not(:disabled) {
              background-color: var(--color-primario-hover);
            }

            .btn-secundario {
              background-color: var(--color-superficie);
              color: var(--color-primario);
              border: 1px solid var(--color-primario);
            }
            .btn-secundario:hover:not(:disabled) {
              background-color: #eef2ff;
            }
            
            .input-field {
              width: 100%;
              padding: 0.75rem;
              border: 1px solid var(--color-borde);
              border-radius: 0.5rem;
              box-sizing: border-box;
              margin-top: 0.5rem;
            }
            
            .spinner, .spinner-small {
              border: 4px solid rgba(0, 0, 0, 0.1);
              border-radius: 50%;
              animation: spin 1s ease infinite;
            }
            .spinner {
              width: 36px;
              height: 36px;
              border-left-color: var(--color-primario);
              margin: 2rem auto;
            }
            .spinner-small {
                width: 18px;
                height: 18px;
                border-width: 2px;
                border-left-color: currentColor;
            }
            
            @keyframes spin {
              0% { transform: rotate(0deg); }
              100% { transform: rotate(360deg); }
            }
            
            @keyframes fadeIn {
              from { opacity: 0; transform: translateY(-10px); }
              to { opacity: 1; transform: translateY(0); }
            }

            /* --- ESTILOS PARA LA FUNCIONALIDAD DE NIVEL --- */
            .level-page-container {
                position: relative;
                width: 100%;
            }

            .side-buttons {
                display: flex;
                flex-direction: column;
                gap: 1rem;
                position: absolute;
                top: 220px; 
                transform: translateY(-50%);
                z-index: 10;
            }

            .side-buttons.left {
                left: 40px; 
                align-items: flex-end;
            }

            .side-buttons.right {
                right: 40px;
                align-items: flex-start;
            }
            
            .btn-side-level {
                background-color: rgba(255, 255, 255, 0.9);
                backdrop-filter: blur(5px);
                border: 1px solid var(--color-borde);
                color: var(--color-texto-secundario);
                padding: 0.8rem 1.4rem;
                font-weight: 600;
                box-shadow: 0 2px 5px rgba(0,0,0,0.08);
                white-space: nowrap;
                transition: all 0.3s ease;
            }
            .btn-side-level:hover {
                background-color: white;
                color: var(--color-primario);
                transform: scale(1.05) translateY(-2px);
                box-shadow: 0 4px 10px rgba(0,0,0,0.12);
            }
            
            .info-overlay {
                position: fixed;
                left: 0;
                top: 0;
                width: 280px; 
                height: 100vh;
                background-color: rgba(255, 255, 255, 0.95);
                backdrop-filter: blur(8px);
                z-index: 100;
                border-right: 1px solid var(--color-borde);
                padding: 2.5rem;
                box-sizing: border-box;
                animation: fadeIn 0.3s ease-out;
            }
            .info-overlay h3 {
                color: var(--color-primario);
                margin-top: 0;
                border-bottom: 2px solid var(--color-primario);
                padding-bottom: 0.5rem;
            }
            .info-overlay ul {
                list-style-type: none;
                padding: 0;
            }
            .info-overlay li {
                margin-bottom: 1rem;
                line-height: 1.6;
            }
            /* --- Estilo para la lista manual en la info --- */
            .info-overlay p {
                line-height: 1.6;
                margin: 0.5rem 0;
            }
            .info-overlay .color-tag {
                display: inline-block;
                padding: 0.1rem 0.4rem;
                border-radius: 4px;
                font-weight: 600;
                color: white;
            }
            
            .exercise-box-tooltip {
              position: relative;
              display: inline-block;
            }
            .exercise-box-tooltip .tooltiptext {
              visibility: hidden;
              width: 160px;
              background-color: #555;
              color: #fff;
              text-align: center;
              border-radius: 6px;
              padding: 5px;
              position: absolute;
              z-index: 1;
              bottom: 125%;
              left: 50%;
              margin-left: -80px;
              opacity: 0;
              transition: opacity 0.3s;
            }
            .exercise-box-tooltip:hover .tooltiptext {
              visibility: visible;
              opacity: 1;
            }

            /* --- ESTILOS PARA LA PÁGINA DE CLASES --- */
            .clases-menu-container {
              display: flex;
              flex-direction: column;
              align-items: center;
              gap: 1.5rem;
              margin-top: 2rem;
            }
            .btn-clase-categoria {
              width: 80%;
              max-width: 500px;
              padding: 1.5rem;
              font-size: 1.25rem;
              text-align: left;
              justify-content: flex-start;
            }
            .video-list-group {
                margin-bottom: 2.5rem;
            }
            .video-list-item {
                display: flex;
                align-items: center;
                gap: 1.5rem;
                padding: 1.25rem;
                border-radius: 0.5rem;
                text-decoration: none;
                color: var(--color-texto-principal);
                background-color: var(--color-superficie);
                border: 1px solid var(--color-borde);
                margin-bottom: 1rem;
                transition: all 0.3s ease;
            }
            .video-list-item:hover {
                transform: translateY(-4px);
                box-shadow: 0 4px 10px rgba(0,0,0,0.1);
                border-color: var(--color-primario);
            }
            .video-list-item-icon {
                flex-shrink: 0;
                width: 48px;
                height: 48px;
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
            }
            .video-list-item-icon svg {
                width: 24px;
                height: 24px;
            }

            /* --- ESTILOS PARA EL MODAL DE EJERCICIO (MEJORADOS) --- */
            .modal-overlay {
              position: fixed;
              top: 0;
              left: 0;
              right: 0;
              bottom: 0;
              background-color: rgba(0, 0, 0, 0.6);
              display: flex;
              align-items: center;
              justify-content: center;
              z-index: 1000;
              animation: fadeIn 0.2s ease-out;
            }
            .modal-content {
              background: var(--color-superficie);
              padding: 2rem;
              border-radius: 0.75rem;
              width: 90%;
              max-width: 800px; /* Ancho aumentado */
              box-shadow: 0 5px 15px rgba(0,0,0,0.3);
              max-height: 85vh; /* Altura máxima */
              display: flex;
              flex-direction: column;
            }
            .modal-header {
              border-bottom: 1px solid var(--color-borde);
              padding-bottom: 1rem;
              margin-bottom: 1rem;
            }
            .modal-header h3 {
              margin: 0;
              color: var(--color-primario);
            }
            .modal-body {
                overflow-y: auto; /* Scroll para contenido largo */
                padding-right: 1rem; /* Espacio para el scrollbar */
                margin-right: -1rem;
            }
            .exam-question-item {
                background-color: #f9fafb;
                border: 1px solid var(--color-borde);
                border-radius: 0.5rem;
                padding: 1.25rem;
                margin-bottom: 1rem;
            }
            .exam-question-item p {
                margin-top: 0;
            }
            .modal-actions {
              margin-top: 1.5rem;
              display: flex;
              justify-content: flex-end;
              gap: 1rem;
              padding-top: 1.5rem;
              border-top: 1px solid var(--color-borde);
            }

          `}</style>
        );

        // --- DATOS Y LÓGICA ---
        const CONTENT_DATA = {
            videos: [
                { id: 'v1', titulo: '01 | CHARACTERISTIC', url: 'https://www.youtube.com/watch?v=nZVK2DBnNtU&t=1s', color: '#E12120' },
                { id: 'v2', titulo: '1.1 | SPECIAL CHARACTERISTIC', url: 'https://www.youtube.com/watch?v=nZVK2DBnNtU&t=1s', color: '#E12120' },
                { id: 'v3', titulo: '02 | FUTURE', url: 'https://www.youtube.com/watch?v=CyjCGve0Et4&t=74s', color: '#008000' },
            ],
            guias: [
                { id: 'g1', titulo: '01 | CHARACTERISTIC', videoUrl: 'https://www.youtube.com/watch?v=nZVK2DBnNtU', imgLadoA: '1.png', imgLadoB: '1b.png', notas: 'Notas para la guía de Characteristic.', pdfEstructura: '1.pdf', pdfTodas: 'todas.pdf', color: '#E12120' },
                { id: 'g2', titulo: '1.1 | SPECIAL CHARACTERISTIC', videoUrl: 'https://www.youtube.com/watch?v=nZVK2DBnNtU', imgLadoA: '11.png', imgLadoB: '11b.png', notas: 'Esta y su variante es una de las unicas que usan description.', pdfEstructura: 'ambasenpeds.pdf', pdfTodas: 'todas.pdf', color: '#E12120' },
                { id: 'g3', titulo: '02 | FUTURE', videoUrl: 'https://www.youtube.com/watch?v=CyjCGve0Et4&t=92s', imgLadoA: '2.png', imgLadoB: '2b.png', notas: 'Notas para la guía de Future.', pdfEstructura: '2.pdf', pdfTodas: 'todas.pdf', color: '#008000' },
                { id: 'g4', titulo: '03 | ABILITY', videoUrl: '#', imgLadoA: '3.png', imgLadoB: '3b.png', notas: 'Notas para la guía de Ability.', pdfEstructura: '3.pdf', pdfTodas: 'todas.pdf', color: '#008000' },
                { id: 'g5', titulo: '04 | ROUTINE AND HABIT', videoUrl: '#', imgLadoA: '4.png', imgLadoB: '4b.png', notas: 'Notas para la guía de Routine and Habit.', pdfEstructura: '4.pdf', pdfTodas: 'todas.pdf', color: '#E12120' },
                { id: 'g6', titulo: '05 | ACTIVITY AT THIS MOMENT', videoUrl: '#', imgLadoA: '5.png', imgLadoB: '5b.png', notas: 'Notas para la guía de Activity at this moment.', pdfEstructura: '5.pdf', pdfTodas: 'todas.pdf', color: '#E12120' },
            ]
        };
        
        const NIVEL_INFO_DATA = {
          '1': {
            leftButtons: [
              { id: 'colores', label: '¿Qué significan los colores, números?', content: () => <div><h3>Colores y Números</h3><ul><li><span className="color-tag" style={{backgroundColor: '#E12120'}}>Rojo</span>: estructuras con variación.</li><li><span className="color-tag" style={{backgroundColor: '#008000'}}>Verde</span>: estructuras que se repiten igual (la chicharronera).</li><li><span className="color-tag" style={{backgroundColor: '#FFD700', color: '#333'}}>Amarillo</span>: ejercicios que combinan estructuras rojas (variables) y verdes (fijas).</li><li><strong>Números (1, 2, 3)</strong>: representan dificultad → 1 = fácil, 2 = medio, 3 = difícil.</li></ul></div> },
              { id: 'obligatorio', label: 'Obligatorio a dominar', content: () => (
                      <div>
                          <h3>Obligatorio a Dominar</h3>
                          <p>Estructuras que debes dominar en este nivel:</p>
                          <div style={{paddingLeft: '10px'}}>
                              <p><strong>1.</strong> Characteristic</p>
                              <p><strong>1.1</strong> Special Characteristic</p>
                              <p><strong>2.</strong> Future</p>
                              <p><strong>3.</strong> Ability</p>
                              <p><strong>4.</strong> Routine and Habit</p>
                              <p><strong>5.</strong> Activity at this Moment</p>
                              <p><strong>6.</strong> Semi-structure for quantity</p>
                          </div>
                      </div>
                  ) 
              }
            ],
            rightButtons: [
              { id: 'proposito', label: '¿Qué hace este nivel en ti?', content: () => <div><h3>Propósito del Nivel</h3><ul><li>Se enfoca únicamente en aprender a estructurar correctamente.</li><li>Se busca que las estructuras sean básicas pero perfectas, sin errores, muy lógicas y con un dominio real.</li><li>No se incluye información adicional o innecesaria.</li><li>El objetivo es que el alumno consolide una base sólida antes de avanzar.</li><li>No se puede pasar al siguiente nivel sin dominar este completamente.</li></ul></div> },
              { id: 'video', label: 'Ver video del nivel', type: 'link', url: 'https://youtu.be/bpzH71Sl7_U?si=jGcQZto8UouXButx' }
            ]
          },
        };

        for (let i = 2; i <= 6; i++) {
            NIVEL_INFO_DATA[i] = {
                leftButtons: [
                    { id: `codigos_${i}`, label: '¿Qué significan los códigos y símbolos?', content: () => <div><h3>Códigos y Símbolos (Nivel {i})</h3><p>Aquí iría la información específica sobre códigos y símbolos para el Nivel {i}.</p></div> },
                    NIVEL_INFO_DATA['1'].leftButtons[1]
                ],
                rightButtons: NIVEL_INFO_DATA['1'].rightButtons
            };
        }

        const CLASES_MENU_DATA = [
            { id: 'estructuras', label: 'Estructuras', overlayContent: () => <p>Aquí encontrarás todas las estructuras en orden.</p> },
            { id: 'extra_info', label: 'Domina la extra information', overlayContent: () => <p>Aquí encontrarás todas las clases referentes a conectores, adornos y muletillas.</p> },
            { id: 'especiales', label: 'Clases especiales', overlayContent: () => <p>Aquí encontrarás las clases especiales que aparecen en los ejercicios de la sección ‘Nivel’.</p> },
            { id: 'pronunciacion', label: 'Pronunciación', overlayContent: () => <div><p>Aquí encontrarás el paso a paso de cómo aprender a pronunciar.</p><p>Se recomienda ver estos videos hasta llegar al nivel correspondiente.</p></div> }
        ];

        const mockDatabase = { 
            get: (key) => JSON.parse(localStorage.getItem(key) || '{}'), 
            set: (key, data) => localStorage.setItem(key, JSON.stringify(data)), 
        };
        const pseudoBcrypt = { hash: (password) => `hashed_${password}_salt`, compare: (password, hash) => hash === `hashed_${password}_salt`, };
        const api = {
         register: async (username, password) => { 
            const db = mockDatabase.get('db');
            if (!db.users) { db.users = []; }
            if (db.users.find(u => u.username === username)) { throw new Error('El nombre de usuario ya existe.'); } 
            const newUser = { id: `user_${Date.now()}`, username, passwordHash: pseudoBcrypt.hash(password) }; 
            db.users.push(newUser); 
            mockDatabase.set('db', db); 
            return { id: newUser.id, username: newUser.username }; 
          },
         login: async (username, password) => { 
            const db = mockDatabase.get('db'); 
            if (!db.users) { db.users = []; }
            const user = db.users.find(u => u.username === username); 
            if (!user || !pseudoBcrypt.compare(password, user.passwordHash)) { throw new Error('Usuario o contraseña incorrectos.'); } 
            return { id: user.id, username: user.username }; 
          },
          getUserProgress: async (userId) => { 
              const db = mockDatabase.get('db');
              return db[userId] || { unlockedLevels: [1], completedExercises: [], examAttempts: {} }; 
          },
          saveUserProgress: async (userId, progress) => {
              const db = mockDatabase.get('db');
              db[userId] = progress;
              mockDatabase.set('db', db);
          }
        };

        // --- COMPONENTES DE REACT ---
        const { useState, useEffect, useMemo } = React;

        function WelcomeScreen() {
            return ( <div style={{ display: 'flex', justifyContent: 'center', alignItems: 'center', width: '100vw', height: '100vh', position: 'fixed', top: 0, left: 0, backgroundColor: 'var(--color-fondo)' }}><img src="1024X875.gif" alt="Bienvenido a Todos Bilingües" style={{ maxWidth: '90%', maxHeight: '90%', borderRadius: '1rem' }} /></div> );
        }

        function AuthPage({ onLogin }) {
            const [isRegistering, setIsRegistering] = useState(false);
            const [username, setUsername] = useState('');
            const [password, setPassword] = useState('');
            const [error, setError] = useState('');
            const [isLoading, setIsLoading] = useState(false);

            const handleSubmit = async (e) => {
                e.preventDefault();
                setError('');
                setIsLoading(true);
                try {
                    const user = isRegistering ? await api.register(username, password) : await api.login(username, password);
                    onLogin(user);
                } catch (err) { setError(err.message); } finally { setIsLoading(false); }
            };

            return (
                <div style={{ maxWidth: '400px', margin: '5rem auto' }}>
                    <div className="card">
                        <div style={{ textAlign: 'center', marginBottom: '1.5rem' }}>
                            <img src="base_logo_transparent_background.png" alt="Logo de Todos Bilingües" style={{ width: '260px', height: 'auto' }} />
                        </div>
                        <form onSubmit={handleSubmit}>
                            <div style={{ marginBottom: '1rem' }}><label htmlFor="username">Usuario</label><input id="username" type="text" className="input-field" value={username} onChange={(e) => setUsername(e.target.value)} required /></div>
                            <div style={{ marginBottom: '1.5rem' }}><label htmlFor="password">Contraseña</label><input id="password" type="password" className="input-field" value={password} onChange={(e) => setPassword(e.target.value)} required /></div>
                            {error && <p style={{ color: 'var(--color-peligro)', textAlign: 'center' }}>{error}</p>}
                            {isLoading ? <div className="spinner" /> : (<button type="submit" className="btn btn-primario" style={{ width: '100%' }}>{isRegistering ? 'Crear Cuenta' : 'Iniciar Sesión'}</button>)}
                        </form>
                        <p style={{ textAlign: 'center', marginTop: '1rem', color: 'var(--color-texto-secundario)' }}>{isRegistering ? '¿Ya tienes una cuenta?' : '¿No tienes una cuenta?'} <button onClick={() => { setIsRegistering(!isRegistering); setError(''); }} style={{ background: 'none', border: 'none', color: 'var(--color-primario)', cursor: 'pointer', fontWeight: 600 }}>{isRegistering ? ' Inicia Sesión' : ' Regístrate'}</button></p>
                    </div>
                </div>
            );
        }

        function Sidebar({ user, onLogout, currentPage, setCurrentPage }) {
            const menuItems = [
                { id: 'paso_a_paso', label: 'Paso a Paso', special: true },
                { id: 'nivel', label: 'Nivel' },
                { id: 'guias', label: 'Guías' },
                { id: 'clases', label: 'Clases' },
                { id: 'ejercicios', label: 'Ejercicios' },
                { id: 'examenes', label: 'Exámenes' },
                { id: 'conversacion', label: 'Práctica de Voz' },
            ];

            return (
                <div style={{ width: '280px', backgroundColor: 'var(--color-superficie)', padding: '1.5rem', height: '100vh', display: 'flex', flexDirection: 'column', borderRight: '1px solid var(--color-borde)', boxSizing: 'border-box', zIndex: 50 }}>
                    <div style={{ textAlign: 'center', marginBottom: '2rem' }}>
                        <img src="base_logo_transparent_background.png" alt="Logo" style={{ width: '150px' }} />
                        <h3 style={{marginTop: '1rem'}}>Hola, {user.username}</h3>
                    </div>
                    <nav style={{ flexGrow: 1 }}>
                        <ul style={{ listStyle: 'none', padding: 0, margin: 0 }}>
                            {menuItems.map(item => (
                                <li key={item.id} style={{ marginBottom: '0.5rem', borderTop: item.special ? '1px solid var(--color-borde)' : 'none', paddingTop: item.special ? '0.5rem' : '0' }}>
                                    <button onClick={() => setCurrentPage(item.id)} className={`btn ${currentPage === item.id ? 'btn-primario' : ''}`} style={{ width: '100%', justifyContent: 'flex-start', backgroundColor: currentPage === item.id ? 'var(--color-primario)' : 'transparent', color: currentPage === item.id ? 'white' : 'var(--color-texto-principal)', fontWeight: item.special ? 800 : 600, padding: '0.75rem' }}>{item.label}</button>
                                </li>
                            ))}
                        </ul>
                    </nav>
                    <div><button onClick={onLogout} className="btn btn-secundario" style={{ width: '100%' }}>Cerrar Sesión</button></div>
                </div>
            );
        }
        
        function PasoAPasoPage() {
            const [codes, setCodes] = useState(Array(5).fill(''));
            const [finalCode, setFinalCode] = useState('?????');
            const handleCodeChange = (index, value) => {
                const newCodes = [...codes];
                newCodes[index] = value.toUpperCase();
                setCodes(newCodes);
                if (newCodes.every(code => code.length === 1)) {
                    setFinalCode(newCodes.join('').split('').reverse().join(''));
                } else {
                    setFinalCode('?????');
                }
            };
            return (
                <div>
                    <h1>Paso a Paso: Todo lo que necesitas saber</h1>
                    <div style={{display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '1.5rem', marginBottom: '2.5rem'}}>
                        <div className="card"><h3>¿Eres Nuevo?</h3><p>Empieza por aquí para entender la plataforma.</p><button className="btn btn-secundario">Ver video</button><a href="#" download className="btn btn-secundario" style={{marginLeft: '0.5rem'}}>Descargar PDF</a></div>
                        <div className="card"><h3>Emparejar Nivel</h3><p>¿No sabes por dónde empezar? Te ayudamos.</p><button className="btn btn-secundario">Ver video</button><a href="#" download className="btn btn-secundario" style={{marginLeft: '0.5rem'}}>Descargar PDF</a></div>
                    </div>
                    <h2>Liberar Potencial</h2>
                    <div className="card">
                        <p>Introduce las letras secretas que obtuviste en los ejercicios para revelar el código de desbloqueo del siguiente nivel.</p>
                        <div style={{display: 'flex', justifyContent: 'space-around', alignItems: 'center', flexWrap: 'wrap', gap: '1rem', padding: '1rem 0'}}>
                            {Array(5).fill(0).map((_, index) => (<div key={index} style={{textAlign: 'center'}}><input id={`code-${index}`} type="text" maxLength="1" value={codes[index]} onChange={(e) => handleCodeChange(index, e.target.value)} style={{width: '50px', height: '60px', textAlign: 'center', fontSize: '1.5rem', borderRadius: '0.5rem', border: '1px solid var(--color-borde)'}} /></div>))}
                        </div>
                        <div style={{textAlign: 'center', marginTop: '1rem'}}><p>Código de desbloqueo: <span style={{fontWeight: 'bold', letterSpacing: '0.2em', backgroundColor: '#eee', padding: '0.25rem 0.5rem', borderRadius: '0.25rem'}}>{finalCode}</span></p></div>
                    </div>
                </div>
            );
        }

        function ExerciseModal({ exercise, onClose, onSubmitResult }) {
            const [answers, setAnswers] = useState({});
            const totalQuestions = exercise.questions.length;

            const handleChange = (index, value) => {
                setAnswers(prev => ({ ...prev, [index]: value }));
            };

            const handleSubmit = (e) => {
                e.preventDefault();
                let correctCount = 0;
                exercise.questions.forEach((q, i) => {
                    if (answers[i] === q.correct) correctCount++;
                });
                const percentage = (correctCount / totalQuestions) * 100;
                onSubmitResult(percentage);
            };

            if (!exercise) return null;

            return (
                <div className="modal-overlay" onClick={onClose}>
                    <div className="modal-content" onClick={(e) => e.stopPropagation()}>
                        <div className="modal-header">
                          <h3>Examen: {exercise.title}</h3>
                        </div>
                        
                        <div className="modal-body">
                          <form onSubmit={handleSubmit}>
                              {exercise.questions.map((q, i) => (
                                  <div key={i} className="exam-question-item">
                                      <p style={{whiteSpace: 'pre-wrap'}}><strong>{i + 1}. {q.question}</strong></p>
                                      {q.options.map((opt, j) => (
                                          <div key={j} style={{padding: '0.25rem 0'}}>
                                              <label style={{display: 'flex', alignItems: 'center', gap: '0.5rem'}}>
                                                  <input
                                                      type="radio"
                                                      name={`q${i}`}
                                                      value={opt.value}
                                                      checked={answers[i] === opt.value}
                                                      onChange={() => handleChange(i, opt.value)}
                                                      required
                                                  />
                                                  {opt.label}
                                              </label>
                                          </div>
                                      ))}
                                  </div>
                              ))}
                              {/* Submit button moved to modal-actions */}
                          </form>
                        </div>

                        <div className="modal-actions">
                            <button type="button" className="btn btn-secundario" onClick={onClose}>Regresar</button>
                            <button type="submit" form="exercise-form" className="btn btn-primario">Enviar Examen</button>
                        </div>
                    </div>
                </div>
            );
        }

        const exam1 = {
            title: "1",
            questions: [
                { question: "¿Cuál es el objective en esta frase?\nBob is silly.", options: [{ label: "a) Bob", value: "a" }, { label: "b) is", value: "b" }, { label: "c) silly", value: "c" }, { label: "d) Bob is", value: "d" }], correct: "a" },
                { question: "¿Cuál es el description en esta frase?\nI am tall.", options: [{ label: "a) I", value: "a" }, { label: "b) tall", value: "b" }, { label: "c) am", value: "c" }, { label: "d) I am", value: "d" }], correct: "b" },
                { question: "¿Cuál es el indicator en esta frase?\nYou are kind.", options: [{ label: "a) kind", value: "a" }, { label: "b) are", value: "b" }, { label: "c) You", value: "c" }, { label: "d) You are", value: "d" }], correct: "b" },
                { question: "¿Cuál es el objective en esta frase?\nThey are smart.", options: [{ label: "a) They", value: "a" }, { label: "b) are", value: "b" }, { label: "c) smart", value: "c" }, { label: "d) are smart", value: "d" }], correct: "a" },
                { question: "¿Cuál es el description en esta frase?\nMario is strong.", options: [{ label: "a) Mario", value: "a" }, { label: "b) is", value: "b" }, { label: "c) strong", value: "c" }, { label: "d) Mario is", value: "d" }], correct: "c" },
                { question: "¿Cuál es el indicator en esta frase?\nWe are funny.", options: [{ label: "a) We", value: "a" }, { label: "b) funny", value: "b" }, { label: "c) are", value: "c" }, { label: "d) are funny", value: "d" }], correct: "c" },
                { question: "¿Cuál es el objective en esta frase?\nLisa is beautiful.", options: [{ label: "a) is", value: "a" }, { label: "b) Lisa", value: "b" }, { label: "c) beautiful", value: "c" }, { label: "d) Lisa is", value: "d" }], correct: "b" },
                { question: "¿Cuál es el description en esta frase?\nI am tired.", options: [{ label: "a) am", value: "a" }, { label: "b) tired", value: "b" }, { label: "c) I", value: "c" }, { label: "d) am tired", value: "d" }], correct: "b" },
                { question: "¿Cuál es el indicator en esta frase?\nBart is lazy.", options: [{ label: "a) Bart", value: "a" }, { label: "b) is", value: "b" }, { label: "c) lazy", value: "c" }, { label: "d) is lazy", value: "d" }], correct: "b" },
                { question: "¿Cuál es el description en esta frase?\nYou are cool.", options: [{ label: "a) You", value: "a" }, { label: "b) cool", value: "b" }, { label: "c) are", value: "c" }, { label: "d) You are", value: "d" }], correct: "b" },
                { question: "¿Cuál es el objective en esta frase?\nI am calm.", options: [{ label: "a) I", value: "a" }, { label: "b) am", value: "b" }, { label: "c) calm", value: "c" }, { label: "d) am calm", value: "d" }], correct: "a" },
                { question: "¿Cuál es el indicator en esta frase?\nSpongeBob is yellow.", options: [{ label: "a) is", value: "a" }, { label: "b) yellow", value: "b" }, { label: "c) SpongeBob", value: "c" }, { label: "d) is yellow", value: "d" }], correct: "a" },
                { question: "¿Cuál es el description en esta frase?\nHomer is hungry.", options: [{ label: "a) Homer", value: "a" }, { label: "b) hungry", value: "b" }, { label: "c) is", value: "c" }, { label: "d) is hungry", value: "d" }], correct: "b" },
                { question: "¿Cuál es el objective en esta frase?\nWe are happy.", options: [{ label: "a) happy", value: "a" }, { label: "b) are", value: "b" }, { label: "c) We", value: "c" }, { label: "d) We are", value: "d" }], correct: "c" },
                { question: "¿Cuál es el indicator en esta frase?\nThey are short.", options: [{ label: "a) They", value: "a" }, { label: "b) short", value: "b" }, { label: "c) are", value: "c" }, { label: "d) are short", value: "d" }], correct: "c" },
            ]
        };
        const exam2 = {
            title: "2",
            questions: [
                { question: "¿Cuál es el description en esta frase?\nI am perfect.", options: [{ label: "a) I", value: "a" }, { label: "b) am", value: "b" }, { label: "c) perfect", value: "c" }, { label: "d) I am", value: "d" }], correct: "c" },
                { question: "¿Cuál es el objective en esta frase?\nBatman is brave.", options: [{ label: "a) Batman", value: "a" }, { label: "b) is", value: "b" }, { label: "c) brave", value: "c" }, { label: "d) is brave", value: "d" }], correct: "a" },
                { question: "¿Cuál es el indicator en esta frase?\nElsa is cold.", options: [{ label: "a) Elsa", value: "a" }, { label: "b) cold", value: "b" }, { label: "c) is", value: "c" }, { label: "d) Elsa is", value: "d" }], correct: "c" },
                { question: "¿Cuál es el description en esta frase?\nIron Man is rich.", options: [{ label: "a) Iron Man", value: "a" }, { label: "b) is", value: "b" }, { label: "c) rich", value: "c" }, { label: "d) is rich", value: "d" }], correct: "c" },
                { question: "¿Cuál es el objective en esta frase?\nI am strong.", options: [{ label: "a) am", value: "a" }, { label: "b) I", value: "b" }, { label: "c) strong", value: "c" }, { label: "d) I am", value: "d" }], correct: "b" },
                { question: "¿Cuál es el indicator en esta frase?\nYou are ready.", options: [{ label: "a) are", value: "a" }, { label: "b) ready", value: "b" }, { label: "c) You", value: "c" }, { label: "d) You are", value: "d" }], correct: "a" },
                { question: "¿Cuál es el description en esta frase?\nBuzz is loud.", options: [{ label: "a) is", value: "a" }, { label: "b) loud", value: "b" }, { label: "c) Buzz", value: "c" }, { label: "d) is loud", value: "d" }], correct: "b" },
                { question: "¿Cuál es el objective en esta frase?\nThey are cool.", options: [{ label: "a) They", value: "a" }, { label: "b) are", value: "b" }, { label: "c) cool", value: "c" }, { label: "d) are cool", value: "d" }], correct: "a" },
                { question: "¿Cuál es el indicator en esta frase?\nWoody is nice.", options: [{ label: "a) Woody", value: "a" }, { label: "b) is", value: "b" }, { label: "c) nice", value: "c" }, { label: "d) is nice", value: "d" }], correct: "b" },
                { question: "¿Cuál es el description en esta frase?\nShe is kind.", options: [{ label: "a) She", value: "a" }, { label: "b) is", value: "b" }, { label: "c) kind", value: "c" }, { label: "d) She is", value: "d" }], correct: "c" },
                { question: "¿Cuál es el objective en esta frase?\nPikachu is fast.", options: [{ label: "a) Pikachu", value: "a" }, { label: "b) fast", value: "b" }, { label: "c) is", value: "c" }, { label: "d) is fast", value: "d" }], correct: "a" },
                { question: "¿Cuál es el indicator en esta frase?\nI am sleepy.", options: [{ label: "a) I", value: "a" }, { label: "b) am", value: "b" }, { label: "c) sleepy", value: "c" }, { label: "d) I am", value: "d" }], correct: "b" },
                { question: "¿Cuál es el description en esta frase?\nShrek is green.", options: [{ label: "a) Shrek", value: "a" }, { label: "b) is", value: "b" }, { label: "c) green", value: "c" }, { label: "d) is green", value: "d" }], correct: "c" },
                { question: "¿Cuál es el objective en esta frase?\nWe are tired.", options: [{ label: "a) tired", value: "a" }, { label: "b) We", value: "b" }, { label: "c) are", value: "c" }, { label: "d) We are", value: "d" }], correct: "b" },
                { question: "¿Cuál es el indicator en esta frase?\nThey are loud.", options: [{ label: "a) They", value: "a" }, { label: "b) are", value: "b" }, { label: "c) loud", value: "c" }, { label: "d) They are", value: "d" }], correct: "b" },
            ]
        };
        const exam3 = {
            title: "3",
            questions: [
                { question: "¿Cuál es el description en esta frase?\nI am shy.", options: [{ label: "a) I", value: "a" }, { label: "b) am", value: "b" }, { label: "c) shy", value: "c" }, { label: "d) I am", value: "d" }], correct: "c" },
                { question: "¿Cuál es el objective en esta frase?\nSuperman is strong.", options: [{ label: "a) is", value: "a" }, { label: "b) Superman", value: "b" }, { label: "c) strong", value: "c" }, { label: "d) is strong", value: "d" }], correct: "b" },
                { question: "¿Cuál es el indicator en esta frase?\nDora is curious.", options: [{ label: "a) Dora", value: "a" }, { label: "b) is", value: "b" }, { label: "c) curious", value: "c" }, { label: "d) Dora is", value: "d" }], correct: "b" },
                { question: "¿Cuál es el description en esta frase?\nI am funny.", options: [{ label: "a) am", value: "a" }, { label: "b) I", value: "b" }, { label: "c) funny", value: "c" }, { label: "d) I am", value: "d" }], correct: "c" },
                { question: "¿Cuál es el objective en esta frase?\nYou are nice.", options: [{ label: "a) nice", value: "a" }, { label: "b) are", value: "b" }, { label: "c) You", value: "c" }, { label: "d) You are", value: "d" }], correct: "c" },
                { question: "¿Cuál es el indicator en esta frase?\nSonic is fast.", options: [{ label: "a) Sonic", value: "a" }, { label: "b) is", value: "b" }, { label: "c) fast", value: "c" }, { label: "d) is fast", value: "d" }], correct: "b" },
                { question: "¿Cuál es el description en esta frase?\nThey are big.", options: [{ label: "a) big", value: "a" }, { label: "b) are", value: "b" }, { label: "c) They", value: "c" }, { label: "d) They are", value: "d" }], correct: "a" },
                { question: "¿Cuál es el objective en esta frase?\nAnna is brave.", options: [{ label: "a) Anna", value: "a" }, { label: "b) brave", value: "b" }, { label: "c) is", value: "c" }, { label: "d) is brave", value: "d" }], correct: "a" },
                { question: "¿Cuál es el indicator en esta frase?\nPatrick is sleepy.", options: [{ label: "a) is", value: "a" }, { label: "b) Patrick", value: "b" }, { label: "c) sleepy", value: "c" }, { label: "d) Patrick is", value: "d" }], correct: "a" },
                { question: "¿Cuál es el description en esta frase?\nWe are strong.", options: [{ label: "a) are", value: "a" }, { label: "b) We", value: "b" }, { label: "c) strong", value: "c" }, { label: "d) We are", value: "d" }], correct: "c" },
                { question: "¿Cuál es el objective en esta frase?\nYou are loud.", options: [{ label: "a) are", value: "a" }, { label: "b) loud", value: "b" }, { label: "c) You", value: "c" }, { label: "d) You are", value: "d" }], correct: "c" },
                { question: "¿Cuál es el indicator en esta frase?\nI am happy.", options: [{ label: "a) I", value: "a" }, { label: "b) am", value: "b" }, { label: "c) happy", value: "c" }, { label: "d) I am", value: "d" }], correct: "b" },
                { question: "¿Cuál es el description en esta frase?\nBuzz is ready.", options: [{ label: "a) Buzz", value: "a" }, { label: "b) ready", value: "b" }, { label: "c) is", value: "c" }, { label: "d) is ready", value: "d" }], correct: "b" },
                { question: "¿Cuál es el objective en esta frase?\nHe is tall.", options: [{ label: "a) tall", value: "a" }, { label: "b) He", value: "b" }, { label: "c) is", value: "c" }, { label: "d) He is", value: "d" }], correct: "b" },
                { question: "¿Cuál es el indicator en esta frase?\nWe are smart.", options: [{ label: "a) are", value: "a" }, { label: "b) smart", value: "b" }, { label: "c) We", value: "c" }, { label: "d) We are", value: "d" }], correct: "a" },
            ]
        };

        function NivelPage({ user, progress, setProgress, onUnlockLevel, onCompleteExercise }) {
            const [currentLevel, setCurrentLevel] = useState(1);
            const [unlockCode, setUnlockCode] = useState('');
            const [hoveredInfo, setHoveredInfo] = useState(null);
            const [modalState, setModalState] = useState({ isOpen: false, exercise: null, onSubmitResult: null });
            
            const levels = [
                { id: 1, name: 'Beginner', color: '#008000', exercises: 67 },
                { id: 2, name: 'Comfort Text', color: '#FFD700', exercises: 15 },
                { id: 3, name: 'Comfort Audio', color: '#FFD700', exercises: 15 },
                { id: 4, name: 'Advanced', color: '#E12120', exercises: 30 },
                { id: 5, name: 'Expert', color: '#2563eb', exercises: 30 },
                { id: 6, name: 'Elite Pro', color: '#111827', exercises: 45 },
            ];
            const exerciseColors = ['#FFF2D1', '#FFCCCC', '#CCFFCC'];
            
            const levelInfo = NIVEL_INFO_DATA[currentLevel];
            const selectedLevel = levels.find(l => l.id === currentLevel);
            
            const handleCloseModal = () => {
                setModalState({ isOpen: false, exercise: null, onSubmitResult: null });
            };
            
            const exerciseBoxes = useMemo(() => {
                const boxes = [];
                const isUnlocked = progress.unlockedLevels.includes(selectedLevel.id);
                for (let i = 0; i < selectedLevel.exercises; i++) {
                    const exerciseId = `L${selectedLevel.id}-E${i + 1}`;
                    const isCompleted = progress.completedExercises.includes(exerciseId);

                    if (isUnlocked) {
                        if (i === 0) { // Video Intro
                            const handleOpenModalWithCode = () => {
                                   const submittedCode = prompt("Introduce el código del video:");
                                   if (submittedCode && submittedCode.toUpperCase() === 'CEROCERO') {
                                       onCompleteExercise(exerciseId);
                                       alert('¡Correcto! Ejercicio aprobado.');
                                   } else {
                                       alert('Código incorrecto. Inténtalo de nuevo.');
                                   }
                             };
                            boxes.push(
                                <div 
                                    key={exerciseId}
                                    onMouseEnter={() => setHoveredInfo(() => () => <div><h3>Ejercicio Introductorio</h3><p>Ver el video para obtener el código del siguiente ejercicio.</p></div>)}
                                    onMouseLeave={() => setHoveredInfo(null)}
                                >
                                    <div 
                                        className="card card-clickable" 
                                        onClick={handleOpenModalWithCode}
                                        style={{ 
                                            width: '60px', 
                                            height: '60px', 
                                            display: 'flex', 
                                            alignItems: 'center', 
                                            justifyContent: 'center', 
                                            backgroundColor: '#3b82f6',
                                            cursor: 'pointer',
                                            border: isCompleted ? '3px solid var(--color-acento)' : '1px solid var(--color-borde)',
                                            boxSizing: 'border-box',
                                            padding: '0'
                                        }}>
                                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="white" viewBox="0 0 16 16"><path d="M8.051 1.999h.089c.822.003 4.987.033 6.11.335a2.01 2.01 0 0 1 1.415 1.42c.101.38.172.883.22 1.402l.01.104.022.26.008.104c.065.914.073 1.77.074 1.957v.075c-.001.194-.01 1.108-.082 2.06l-.008.105-.022.26-.01.104c-.048.519-.119 1.023-.22 1.402a2.01 2.01 0 0 1-1.415 1.42c-1.16.312-5.569.334-6.18.335h-.142c-.309 0-1.587-.006-2.927-.052l-.17-.006-.087-.004-.171-.007-.053-.002c-.017 0-.033-.001-.046-.002-.027-.002-.05-.003-.072-.004-.011-.001-.022-.001-.033-.001h-.004c-1.106-.04-4.287-.12-5.134-.33a2.01 2.01 0 0 1-1.415-1.419c-.111-.378-.185-.879-.23-1.392l-.01-.104-.022-.26-.008-.104c-.065-.914-.073-1.77-.074-1.957v-.075c.001-.194.01-1.108.082-2.06l.008-.105.022-.26.01-.104c.048-.519.119-1.023.22-1.402a2.01 2.01 0 0 1 1.415-1.419c1.16-.312 5.569-.334 6.18-.335h.142zM6.404 8.49l4.28-2.539-4.28-2.54v5.08z"/></svg>
                                    </div>
                                </div>
                            );
                        } else if (i === 1) { // Exam Box
                            const examAttempts = progress.examAttempts?.[exerciseId] || 0;
                            const examIndex = examAttempts % 3;
                            const exams = [exam1, exam2, exam3];
                            const currentExam = exams[examIndex];

                            const handleExamResult = (percentage) => {
                                const newAttempts = { ...(progress.examAttempts || {}), [exerciseId]: examAttempts + 1 };
                                let newCompleted = [...progress.completedExercises];
                                
                                if (percentage >= 85) {
                                    if (!newCompleted.includes(exerciseId)) {
                                       newCompleted.push(exerciseId);
                                    }
                                    alert('¡Examen aprobado!');
                                } else {
                                    alert('Reprobado. Intentarás el siguiente examen.');
                                }
                                
                                const newProgress = { ...progress, examAttempts: newAttempts, completedExercises: newCompleted };
                                setProgress(newProgress);
                                api.saveUserProgress(user.id, newProgress);
                                handleCloseModal();
                            };

                            boxes.push(
                                <div
                                    key={exerciseId}
                                    onMouseEnter={() => setHoveredInfo(() => () => <div><h3>Examen Identificación</h3><p>Debes aprobar con 85% o más. Si fallas, el examen cambia.</p></div>)}
                                    onMouseLeave={() => setHoveredInfo(null)}
                                >
                                    <div
                                        className="card card-clickable"
                                        onClick={() => setModalState({ isOpen: true, exercise: { ...currentExam, id: exerciseId }, onSubmitResult: handleExamResult })}
                                        style={{
                                            width: '60px',
                                            height: '60px',
                                            backgroundColor: '#2563eb',
                                            color: 'white',
                                            border: isCompleted ? '3px solid var(--color-acento)' : '1px solid var(--color-borde)',
                                            display: 'flex',
                                            alignItems: 'center',
                                            justifyContent: 'center',
                                            cursor: 'pointer',
                                            padding: 0,
                                            boxSizing: 'border-box'
                                        }}
                                    >
                                        <span style={{ fontWeight: 'bold' }}>2</span>
                                    </div>
                                </div>
                            );
                        } else { // Regular exercises
                            boxes.push(
                                <div key={exerciseId} className="card" style={{ 
                                    width: '60px', 
                                    height: '60px', 
                                    display: 'flex', 
                                    alignItems: 'center', 
                                    justifyContent: 'center', 
                                    backgroundColor: exerciseColors[i % 3], 
                                    cursor: 'pointer',
                                    border: isCompleted ? '3px solid var(--color-acento)' : '1px solid var(--color-borde)',
                                    boxSizing: 'border-box',
                                    padding: '0'
                                }}>
                                    <span style={{fontSize: '1.5rem', fontWeight: 700}}>{i % 3 + 1}</span>
                                </div>
                            );
                        }
                    } else { // Locked exercises
                        boxes.push(<div key={i} className="card" style={{ width: '60px', height: '60px', display: 'flex', alignItems: 'center', justifyContent: 'center', backgroundColor: '#e0e0e0', cursor: 'not-allowed', padding: '0' }}><span style={{fontSize: '2rem', color: 'var(--color-peligro)'}}>?</span></div>);
                    }
                }
                return boxes;
            }, [progress, selectedLevel.id, currentLevel, user]); 
            
            const handleUnlock = () => { if (unlockCode === 'ABCDE') { onUnlockLevel(currentLevel); alert(`¡Nivel ${currentLevel} desbloqueado!`); setUnlockCode(''); } else { alert('Código incorrecto.'); } };
            const isSelectedLevelUnlocked = progress.unlockedLevels.includes(selectedLevel.id);

            return (
                <div className="level-page-container">
                    {modalState.isOpen && <ExerciseModal exercise={modalState.exercise} onClose={handleCloseModal} onSubmitResult={modalState.onSubmitResult} />}
                    {hoveredInfo && <div className="info-overlay">{hoveredInfo()}</div>}
                    <div className="side-buttons left">{levelInfo.leftButtons.map(btn => <button key={btn.id} className="btn btn-side-level" onMouseEnter={() => setHoveredInfo(() => btn.content)} onMouseLeave={() => setHoveredInfo(null)}>{btn.label}</button>)}</div>
                    <div className="side-buttons right">
                        {levelInfo.rightButtons.map(btn => 
                            btn.type === 'link' 
                            ? <a key={btn.id} href={btn.url} target="_blank" rel="noopener noreferrer" className="btn btn-side-level">{btn.label}</a>
                            : <button key={btn.id} className="btn btn-side-level" onMouseEnter={() => setHoveredInfo(() => btn.content)} onMouseLeave={() => setHoveredInfo(null)}>{btn.label}</button>
                        )}
                    </div>

                    <h1>Niveles de Progreso</h1>
                    <div style={{display: 'flex', justifyContent: 'center', gap: '0.5rem', marginBottom: '2rem', flexWrap: 'wrap'}}>{levels.map(level => <button key={level.id} onClick={() => { setCurrentLevel(level.id); setHoveredInfo(null); }} className={currentLevel === level.id ? 'btn btn-primario' : 'btn btn-secundario'}>Nivel {level.id}</button>)}</div>
                    
                    <div className="card" style={{textAlign: 'center', position: 'relative', zIndex: 5}}>
                        <div style={{display: 'flex', flexDirection: 'column', alignItems: 'center', gap: '1.5rem'}}>
                            <div style={{ width: '150px', height: '150px', borderRadius: '50%', backgroundColor: selectedLevel.color, display: 'flex', alignItems: 'center', justifyContent: 'center', color: selectedLevel.color === '#FFD700' ? '#333' : 'white', border: '4px solid rgba(255,255,255,0.5)', boxShadow: '0 0 15px rgba(0,0,0,0.2)' }}><h2 style={{margin: 0, fontSize: '1.2rem', textAlign: 'center'}}>{selectedLevel.name}</h2></div>
                            {!isSelectedLevelUnlocked && <div style={{padding: '1rem', border: '1px dashed var(--color-borde)', borderRadius: '0.5rem'}}><p>Este nivel está bloqueado. Introduce el código de 5 dígitos para acceder.</p><div style={{display: 'flex', gap: '0.5rem', justifyContent: 'center'}}><input type="text" value={unlockCode} onChange={(e) => setUnlockCode(e.target.value.toUpperCase())} maxLength="5" placeholder="CÓDIGO" style={{width: '120px', textAlign: 'center', letterSpacing: '0.2em'}} className="input-field" /><button onClick={handleUnlock} className="btn btn-primario">Desbloquear</button></div></div>}
                            <div style={{display: 'flex', flexWrap: 'wrap', justifyContent: 'center', gap: '1rem', maxWidth: '90%'}}>{exerciseBoxes}</div>
                        </div>
                    </div>
                </div>
            );
        }
        
        function EjerciciosHubPage() {
            const items = ["Ejercicios de Estructuras Específicas", "Arma tu Kit", "Avanzado", "Checar Diario", "My personal tutor", "Revisión de Ejercicios", "Desarrollar Habilidad Especial", "Vocabulario Personalizado"];
            return (
                <div><h1>Ejercicios</h1><p>Elige una categoría para practicar.</p><div style={{display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(250px, 1fr))', gap: '1.5rem'}}>{items.map(item => <div key={item} className="card card-clickable"><h3 style={{marginTop: 0, color: 'var(--color-primario)'}}>{item}</h3></div>)}</div></div>
            );
        }

        function ExamenesPage() {
            const levels = [1, 2, 3, 4, 5, 6];
            return (
                <div>
                    <h1>Exámenes de Acreditación</h1>
                    <div className="card" style={{marginBottom: '2rem'}}>
                        <p><strong>Importante:</strong> Antes de hacer el examen, te recomendamos ver el video de preparación o descargar la guía de estudio.</p>
                        <button className="btn btn-secundario">Ver video</button>
                        <a href="#" download className="btn btn-secundario" style={{marginLeft: '0.5rem'}}>Descargar PDF</a>
                    </div>
                    {levels.map(level => (
                        <div key={level} className="card" style={{marginBottom: '1rem'}}>
                            <h3>Examen para acreditar Nivel {level}</h3>
                            <button className="btn btn-primario">Iniciar Examen</button>
                        </div>
                    ))}
                </div>
            );
        }
        
        function PracticaVozHubPage({ onSelect }) {
             return (
                 <div>
                     <h1>Práctica de Voz</h1>
                     <p>Elige tu modo de práctica conversacional.</p>
                     <div style={{display: 'flex', gap: '1.5rem', justifyContent: 'center'}}>
                         <div className="card card-clickable" onClick={() => onSelect('chant')}>
                             <h3 style={{marginTop: 0}}>Platicar con tu tutor personal</h3>
                         </div>
                         <div className="card card-clickable" onClick={() => onSelect('natural')}>
                            <h3 style={{marginTop: 0}}>Plática Natural</h3>
                         </div>
                     </div>
                 </div>
            );
        }
        
        function VideoGridPage({ title, videos, onBack }) {
            const groupedVideos = useMemo(() => {
                return videos.reduce((acc, video) => {
                    const videoNum = parseFloat(video.titulo.split(' ')[0]);
                    if (isNaN(videoNum)) return acc;

                    const groupIndex = Math.floor((videoNum - 1) / 10);
                    const groupTitle = `Estructuras ${groupIndex * 10 + 1} - ${(groupIndex + 1) * 10}`;
                    
                    if (!acc[groupTitle]) {
                        acc[groupTitle] = [];
                    }
                    acc[groupTitle].push(video);
                    return acc;
                }, {});
            }, [videos]);

            return (
                <div>
                    <button onClick={onBack} className="btn btn-secundario" style={{marginBottom: '1.5rem'}}>← Regresar al menú de clases</button>
                    <h1>{title}</h1>
                    <p>Refuerza conceptos clave con estas explicaciones en video.</p>
                    {Object.keys(groupedVideos).length > 0 ? Object.entries(groupedVideos).map(([groupTitle, groupVideos]) => (
                        <div key={groupTitle} className="video-list-group">
                            <h2 style={{borderBottom: '2px solid var(--color-borde)', paddingBottom: '0.5rem'}}>{groupTitle}</h2>
                            {groupVideos.map(item => (
                                <a href={item.url} target="_blank" rel="noopener noreferrer" key={item.id} className="video-list-item">
                                    <div className="video-list-item-icon" style={{backgroundColor: item.color || 'var(--color-primario)'}}>
                                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="white" viewBox="0 0 16 16"><path d="M8.051 1.999h.089c.822.003 4.987.033 6.11.335a2.01 2.01 0 0 1 1.415 1.42c.101.38.172.883.22 1.402l.01.104.022.26.008.104c.065.914.073 1.77.074 1.957v.075c-.001.194-.01 1.108-.082 2.06l-.008.105-.022.26-.01.104c-.048.519-.119 1.023-.22 1.402a2.01 2.01 0 0 1-1.415 1.42c-1.16.312-5.569.334-6.18.335h-.142c-.309 0-1.587-.006-2.927-.052l-.17-.006-.087-.004-.171-.007-.053-.002c-.017 0-.033-.001-.046-.002-.027-.002-.05-.003-.072-.004-.011-.001-.022-.001-.033-.001h-.004c-1.106-.04-4.287-.12-5.134-.33a2.01 2.01 0 0 1-1.415-1.419c-.111-.378-.185-.879-.23-1.392l-.01-.104-.022-.26-.008-.104c-.065-.914-.073-1.77-.074-1.957v-.075c.001-.194.01-1.108.082-2.06l.008-.105.022-.26.01-.104c.048-.519.119-1.023.22-1.402a2.01 2.01 0 0 1 1.415-1.419c1.16-.312 5.569-.334 6.18-.335h.142zM6.404 8.49l4.28-2.539-4.28-2.54v5.08z"/></svg>
                                    </div>
                                    <h4 style={{margin: 0, fontWeight: 600}}>{item.titulo}</h4>
                                </a>
                            ))}
                        </div>
                    )) : <div className="card"><p>Aún no hay videos en esta categoría.</p></div>}
                </div>
            );
        }
        
        function ClasesMenu({ onSelectCategory }) {
            const [hoveredInfo, setHoveredInfo] = useState(null);
            return (
                <div style={{position: 'relative'}}>
                    {hoveredInfo && <div className="info-overlay"><h3>Información</h3>{hoveredInfo()}</div>}
                    <h1>Clases</h1>
                    <div className="clases-menu-container">
                        {CLASES_MENU_DATA.map(cat => <button key={cat.id} className="btn btn-primario btn-clase-categoria" onMouseEnter={() => setHoveredInfo(() => cat.overlayContent)} onMouseLeave={() => setHoveredInfo(null)} onClick={() => onSelectCategory(cat.id)}>{cat.label}</button>)}
                    </div>
                </div>
            );
        }

        function ClasesPage() {
            const [subPage, setSubPage] = useState('menu');
            const handleBackToMenu = () => setSubPage('menu');

            switch (subPage) {
                case 'estructuras': return <VideoGridPage title="Clases de Estructuras" videos={CONTENT_DATA.videos} onBack={handleBackToMenu} />;
                case 'extra_info': return <VideoGridPage title="Domina la Extra Information" videos={[]} onBack={handleBackToMenu} />;
                case 'especiales': return <VideoGridPage title="Clases Especiales" videos={[]} onBack={handleBackToMenu} />;
                case 'pronunciacion': return <VideoGridPage title="Clases de Pronunciación" videos={[]} onBack={handleBackToMenu} />;
                default: return <ClasesMenu onSelectCategory={(categoryId) => setSubPage(categoryId)} />;
            }
        }
        
        function GuiasPage({ onSelectGuia }) {
             const groupedGuias = useMemo(() => {
                 return CONTENT_DATA.guias.reduce((acc, guia) => {
                     const guiaNum = parseFloat(guia.titulo.split(' ')[0]);
                     if (isNaN(guiaNum)) return acc;

                     const groupIndex = Math.floor((guiaNum - 1) / 10);
                     const groupTitle = `Guías ${groupIndex * 10 + 1} - ${(groupIndex + 1) * 10}`;
                     
                     if (!acc[groupTitle]) {
                         acc[groupTitle] = [];
                     }
                     acc[groupTitle].push(guia);
                     return acc;
                 }, {});
             }, [CONTENT_DATA.guias]);

             return (
                 <div>
                     <h1>Guías de Estructuras</h1>
                     <p>Explora nuestras fichas visuales. Haz clic en una para verla en detalle.</p>
                     {Object.entries(groupedGuias).map(([groupTitle, groupItems]) => (
                         <div key={groupTitle} className="video-list-group">
                              <h2 style={{borderBottom: '2px solid var(--color-borde)', paddingBottom: '0.5rem'}}>{groupTitle}</h2>
                              <div style={{ display: 'grid', gap: '1.5rem', gridTemplateColumns: 'repeat(auto-fill, minmax(220px, 1fr))' }}>
                                  {groupItems.map(guia => <div key={guia.id} onClick={() => onSelectGuia(guia.id)} className="card-clickable" style={{ borderTop: `12px solid ${guia.color}`, cursor: 'pointer', padding: '1rem' }}><img src={guia.imgLadoA} alt={guia.titulo} style={{ width: '100%', borderRadius: '6px', marginBottom: '1rem' }} /><h4 style={{ textAlign: 'center', margin: 0, color: 'var(--color-texto-principal)' }}>{guia.titulo}</h4></div>)}
                              </div>
                         </div>
                     ))}
                 </div>
               );
        }

        function GuiaDetailPage({ guia, onBack }) {
          const [showA, setShowA] = useState(true);
          if (!guia) return (<div><p>Cargando guía o no se encontró...</p><button onClick={onBack} className="btn">Regresar</button></div>);
          return (
            <div>
              <button onClick={onBack} className="btn btn-secundario" style={{marginBottom: '1.5rem'}}>← Volver a todas las guías</button>
              <div className="card">
                  <h1 style={{textAlign: 'center', marginTop: 0}}>{guia.titulo}</h1>
                  <p style={{textAlign: 'center', color: 'var(--color-texto-secundario)'}}>{guia.notas}</p>
                  <div style={{ display: 'flex', gap: '1rem', justifyContent: 'center', marginBottom: '1.5rem' }}><button onClick={() => setShowA(true)} className={`btn ${showA ? 'btn-primario' : 'btn-secundario'}`}>Ver Lado A</button><button onClick={() => setShowA(false)} className={`btn ${!showA ? 'btn-primario' : 'btn-secundario'}`}>Ver Lado B</button></div>
                  <div style={{ textAlign: 'center', marginBottom: '1.5rem' }}><img src={showA ? guia.imgLadoA : guia.imgLadoB} alt={showA ? 'Lado A' : 'Lado B'} style={{ maxWidth: '90%', borderRadius: '10px', boxShadow: '0 0 10px rgba(0,0,0,0.2)', border: '1px solid var(--color-borde)' }} /></div>
                  <div style={{ borderTop: '1px solid var(--color-borde)', paddingTop: '1.5rem', marginTop: '1.5rem', textAlign: 'center', display: 'flex', justifyContent: 'center', gap: '1rem', flexWrap: 'wrap' }}><a href={guia.videoUrl} target="_blank" rel="noopener noreferrer" className="btn btn-secundario"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14m0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16"/><path d="M6.271 5.055a.5.5 0 0 1 .52.038l3.5 2.5a.5.5 0 0 1 0 .814l-3.5 2.5A.5.5 0 0 1 6 10.5v-5a.5.5 0 0 1 .271-.445"/></svg> Ir al video</a><a href={guia.pdfEstructura} download className="btn btn-primario">Descargar esta estructura</a></div>
              </div>
            </div>
          );
        }

        // --- COMPONENTE PRINCIPAL DE LA APLICACIÓN ---
        function App() {
          const [showWelcome, setShowWelcome] = useState(true);
          const [user, setUser] = useState(null);
          const [page, setPage] = useState('auth'); 
          const [isLoading, setIsLoading] = useState(true);
          const [progress, setProgress] = useState({ unlockedLevels: [1], completedExercises: [], examAttempts: {} });
          const [selectedGuiaId, setSelectedGuiaId] = useState(null);

          useEffect(() => { const welcomeTimer = setTimeout(() => setShowWelcome(false), 2000); return () => clearTimeout(welcomeTimer); }, []);
          useEffect(() => { 
              if (showWelcome) return; 
              try { 
                  const savedUser = JSON.parse(localStorage.getItem('todos_bilingues_user')); 
                  if (savedUser && savedUser.id) { 
                      setUser(savedUser); 
                      setPage('paso_a_paso'); 
                  } 
              } catch (e) { 
                  localStorage.removeItem('todos_bilingues_user'); 
              } 
              setIsLoading(false); 
          }, [showWelcome]);

          useEffect(() => { 
              if(user && user.id) { 
                  const fetchUserProgress = async () => { 
                      const userProgress = await api.getUserProgress(user.id); 
                      setProgress(userProgress); 
                  }; 
                  fetchUserProgress(); 
              } 
          }, [user]);

          const handleLogin = (loggedInUser) => { 
              setUser(loggedInUser); 
              localStorage.setItem('todos_bilingues_user', JSON.stringify(loggedInUser)); 
              setPage('paso_a_paso'); 
          };
          const handleLogout = () => { 
              setUser(null); 
              localStorage.removeItem('todos_bilingues_user'); 
              setPage('auth'); 
          };
          const handleSelectGuia = (guiaId) => { 
              setSelectedGuiaId(guiaId); 
              setPage('guia_detail'); 
          };
          const handleBackToGuias = () => { 
              setSelectedGuiaId(null); 
              setPage('guias'); 
          };
          const handleVoicePracticeSelect = (type) => alert(`Iniciando práctica de voz: ${type}`);
          const handleUnlockLevel = (levelId) => {
              const newProgress = { ...progress, unlockedLevels: [...progress.unlockedLevels, levelId] };
              setProgress(newProgress);
              api.saveUserProgress(user.id, newProgress);
          };
          const handleCompleteExercise = (exerciseId) => {
              if (progress.completedExercises.includes(exerciseId)) return;
              const newProgress = { ...progress, completedExercises: [...progress.completedExercises, exerciseId] };
              setProgress(newProgress);
              api.saveUserProgress(user.id, newProgress);
          };

          const renderPage = () => {
            if (showWelcome) return <WelcomeScreen />;
            if (isLoading) return <div style={{ display: 'flex', justifyContent: 'center', alignItems: 'center', height: '100vh' }}><div className="spinner"></div></div>;
            if (!user) return <AuthPage onLogin={handleLogin} />;
            
            let content;
            case 'nivel': content = <NivelPage user={user} progress={progress} setProgress={setProgress} onUnlockLevel={handleUnlockLevel} onCompleteExercise={handleCompleteExercise} />; break;
              case 'guias': content = <GuiasPage onSelectGuia={handleSelectGuia} />; break;
              case 'guia_detail': const selectedGuia = CONTENT_DATA.guias.find(g => g.id === selectedGuiaId); content = <GuiaDetailPage guia={selectedGuia} onBack={handleBackToGuias} />; break;
              case 'clases': content = <ClasesPage />; break;
              case 'ejercicios': content = <EjerciciosHubPage />; break;
              case 'examenes': content = <ExamenesPage />; break;
              case 'conversacion': content = <PracticaVozHubPage onSelect={handleVoicePracticeSelect} />; break;
              default: content = <PasoAPasoPage />;
            }

            return (
                 <div className="app-layout">
                     <Sidebar user={user} onLogout={handleLogout} currentPage={page} setCurrentPage={setPage} />
                     <main className="main-content">{content}</main>
                 </div>
            );
          };

          return (
            <React.Fragment>
                <GlobalStyles />
                <div className="watermark-bg">
                    {renderPage()}
                </div>
            </React.Fragment>
          );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);

    </script>
</body>
</html>          switch (page) {
              case 'paso_a_paso': content = <PasoAPasoPage />; break;
    